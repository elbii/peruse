#!/usr/bin/env ruby
$LOAD_PATH << './lib'
require 'plunk'
require 'optparse'

options = {}
OptionParser.new do |opts|
  opts.banner = "Usage: plunk [options]"
  opts.separator ""
  opts.separator "Options"

  opts.on(
    "-h",
    "--host HOST",
    "comma-separated list of Elasticsearch hosts to use"
  ) do |option|
    options[:host] = option
  end

  opts.on(
    "-p",
    "--parse-only",
    "parse but don't execute query, returning ES-compatible JSON"
  ) do |option|
    options[:parse_only] = option
  end

  opts.on(
    "-s",
    "--size SIZE",
    "max number of hits to return"
  ) do |option|
    options[:size] = option
  end
  
  opts.on(
    "-r",
    "--randomize-hosts",
    "randomize hosts used for each search"
  ) do |option|
    options[:randomize_hosts] = option
  end

end.parse!

Plunk.configure do |c|
  c.parse_only = options[:parse_only]
  c.max_number_of_hits = options[:size]

  c.elasticsearch_client = Elasticsearch::Client.new(
    host: options[:host].split(','),
    randomize_hosts: options[:randomize_hosts]
  ) unless c.parse_only
end

puts Plunk.search($stdin.read).to_json
